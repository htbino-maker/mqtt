<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="manifest.json">
  <title>Campainha</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root {
      --bg: #000000;
      --surface: #0d0d0d;
      --btn: #111111;
      --border: #2a2a2a;
      --accent: #00ff66;
      --error: #ff3333;
      --text: #ffffff;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      overflow: hidden;
    }

    header {
      text-align: center;
      padding: 10px;
      font-size: 4vw;
      font-weight: bold;
      background: var(--surface);
      color: var(--text);
      letter-spacing: 4px;
    }

    .status {
      text-align: center;
      padding: 6px;
      font-size: 1.5vw;
      background: #000000;
      letter-spacing: 1px;
      color: #ffaa00;
    }

    footer {
      text-align: center;
      padding: 8px;
      font-size: 2.2vw;
      background: #000000;
      letter-spacing: 1px;
      color: #777777;
      border-top: 1px solid #222;
    }

    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 8px;
      padding: 10px;
      box-sizing: border-box;
    }

    button {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5.5vw;
      font-weight: bold;
      background: var(--btn);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 16px;
      cursor: pointer;
      transition: 0.1s;
    }

    button:hover {
      background: #1a1a1a;
    }

    button:active {
      background: var(--accent);
      color: #000000;
      transform: scale(0.95);
    }

    #displayChamada {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12vw;
      font-weight: bold;
      color: var(--accent);
      background: #000000;
      border: 4px solid var(--accent);
      padding: 40px 80px;
      border-radius: 30px;
      display: none;
      z-index: 9999;
      text-align: center;
      box-shadow: 0 0 60px rgba(0, 255, 100, 0.5);
    }
  </style>
</head>

<body>

  <header>
    CAMPAINHA
  </header>

  <div class="status" id="status">
    Conectando ao broker...
  </div>

  <div class="grid" id="botoes"></div>

  <div id="displayChamada"></div>

  <footer>
    Vilinha Metrô Jabaquara
  </footer>

  <script>
    // Registro do Service Worker (Obrigatório para PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
      });
    }

    const broker = "ws://192.168.0.122:8083/mqtt";
    const TOTAL_APARTAMENTOS = 22;

    const statusEl = document.getElementById("status");
    const client = mqtt.connect(broker);

    client.on("connect", () => {
      statusEl.innerText = "Conectado";
      statusEl.style.color = "#00ff66";
    });

    client.on("reconnect", () => {
      statusEl.innerText = "Reconectando...";
      statusEl.style.color = "#ffaa00";
    });

    client.on("error", () => {
      statusEl.innerText = "Erro de conexão";
      statusEl.style.color = "#ff3333";
    });

    const apartamentos = Array.from(
      { length: TOTAL_APARTAMENTOS },
      (_, i) => (i + 1).toString()
    );

    const display = document.getElementById("displayChamada");
    let timeoutAtual = null;

    //////////////////////////////////////////////////////
    // SOM DING DONG
    //////////////////////////////////////////////////////

    function tocarCampainha() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      function beep(freq, duration, delay) {
        setTimeout(() => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = "sine";
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.4, ctx.currentTime);
          osc.start();
          osc.stop(ctx.currentTime + duration);
        }, delay);
      }

      beep(900, 0.3, 0);
      beep(600, 0.4, 350);
    }

    //////////////////////////////////////////////////////
    // FALA DO APARTAMENTO
    //////////////////////////////////////////////////////

    function falarApartamento(apto) {

      if (!('speechSynthesis' in window)) {
        console.log("Speech não suportado");
        return;
      }

      const mensagem = new SpeechSynthesisUtterance(
        "Chamando apartamento " + apto
      );

      mensagem.lang = "pt-BR";
      mensagem.rate = 1.0;
      mensagem.pitch = 1.0;
      mensagem.volume = 1.0;

      const vozes = speechSynthesis.getVoices();
      if (vozes.length > 0) {
        const vozPt = vozes.find(v => v.lang === "pt-BR");
        if (vozPt) mensagem.voice = vozPt;
      }

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(mensagem);
    }

    //////////////////////////////////////////////////////
    // EXIBIR + SOM + FALA
    //////////////////////////////////////////////////////

    function mostrarApartamento(apto) {
      display.innerText = apto;
      display.style.display = "block";

      tocarCampainha();
      falarApartamento(apto);

      if (timeoutAtual) clearTimeout(timeoutAtual);

      timeoutAtual = setTimeout(() => {
        display.style.display = "none";
        timeoutAtual = null;
      }, 5000);
    }

    //////////////////////////////////////////////////////
    // CRIAÇÃO DOS BOTÕES
    //////////////////////////////////////////////////////

    const container = document.getElementById("botoes");

    apartamentos.forEach(apto => {
      const btn = document.createElement("button");
      btn.innerText = apto;

      btn.onclick = () => {

        const numeroApto = parseInt(apto);
        const topico = "condominio/campainha/apto/" + numeroApto;

        client.publish(topico, "1");

        mostrarApartamento(apto);
      };

      container.appendChild(btn);
    });

  </script>
</body>

</html>
